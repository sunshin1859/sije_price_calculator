<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIJE Subscription Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Pretendard Variable', sans-serif;
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 40px;
      border: 1px solid #ccc;
    }
    .flex-row {
      display: flex;
      gap: 40px;
    }
    .form-section {
      flex: 1;
    }
    .result {
      flex: 2;
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ddd;
      overflow-x: auto;
    }
    label { display: block; margin-top: 10px; }
    input[type="text"], input[type="number"], select { width: 100%; padding: 4px; margin-top: 4px; }
    .saved-list { margin-top: 10px; font-size: 0.9em; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background-color: #f0f0f0; }
    .highlight { background-color: #e3f7d9; font-weight: bold; }
    canvas { margin-top: 20px; }
    .remark-box {
      background: #fffdf0;
      border: 1px dashed #bbb;
      padding: 10px;
      font-size: 0.9em;
      line-height: 1.6em;
    }
    .remark-details {
      margin-top: 8px;
      font-size: 0.85em;
      color: #444;
    }
    .remark-details ul {
      margin-top: 5px;
      padding-left: 18px;
    }
    .remark-details li {
      margin-bottom: 4px;
    }
    .service-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.85em;
    }
    .service-table th, .service-table td {
      border: 1px solid #aaa;
      padding: 6px;
      text-align: center;
    }
    .service-table th {
      background-color: #f5f5f5;
    }
    button {
      padding: 8px 16px;
      margin-top: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <div class="flex-row">
    <div class="form-section">
      <h1>SIJE Subscription Calculator</h1>
      <label>Company Name
        <input type="text" id="companyName" placeholder="Enter company name">
      </label>
      <label>Company Type
        <select id="companyType">
          <option value="">Select</option>
          <option value="production">Production Focused</option>
          <option value="sourcing">Sourcing Focused</option>
          <option value="data">Data Focused</option>
        </select>
      </label>
      <label>Number of Machines
        <input type="number" id="machines" value="0">
      </label>
      <label>Number of Users (Monolis)
        <input type="number" id="users" value="0">
      </label>
      <button id="simulateBtn">Run Simulation</button>
      <button id="saveBtn">Save Simulation</button>

      <div class="saved-list">
        <h4>ðŸ“‚ Saved Simulations</h4>
        <ul id="savedSimulations"></ul>
      </div>

      <div class="remark-box">
        <strong>ðŸ“Œ Remark</strong><br>
        Calculation criteria and application ratios:
        <div class="remark-details">
          <ul>
            <li><strong>Acquire (PoC)</strong>: Only <strong>5%</strong> of total (machines or users) applied. Demo phase with $15,000 installation fee.</li>
            <li><strong>Expand</strong>: <strong>20%</strong> of total applied. Formal contracts begin for some factories/users.</li>
            <li><strong>Standardize</strong>: <strong>70%</strong> of total applied. Enterprise-wide system standardization.</li>
            <li><strong>Monolog</strong>: Machine-based. Subscription fee per 120 machines.</li>
            <li><strong>MoAI</strong>: AI service based on Monolog (2x Monolog fee).</li>
            <li><strong>Monolis</strong>: User-based. Monthly fee per user.</li>
          </ul>
          <strong>ðŸ’¡ Service Composition by Company Type</strong>
          <table class="service-table">
            <tr>
              <th>Year</th>
              <th>Production Focused</th>
              <th>Sourcing Focused</th>
              <th>Data Focused</th>
            </tr>
            <tr>
              <td>Year 1 (PoC)</td>
              <td>Monolog</td>
              <td>Monolis</td>
              <td>MoAI</td>
            </tr>
            <tr>
              <td>Year 2 (Expand)</td>
              <td>Monolog + MoAI</td>
              <td>Monolog + MoAI + Monolis</td>
              <td>MoAI + Monolis</td>
            </tr>
            <tr>
              <td>Year 3 (Expand)</td>
              <td>Monolog + MoAI + Monolis</td>
              <td>Monolog + MoAI + Monolis</td>
              <td>MoAI + Monolis</td>
            </tr>
            <tr>
              <td>Year 4 (Standardize)</td>
              <td>Monolog + MoAI + Monolis</td>
              <td>Monolog + MoAI + Monolis</td>
              <td>MoAI + Monolis</td>
            </tr>
          </table>
        </div>
      </div>
    </div>
    <div class="result" id="result"></div>
  </div>

  <div class="result">
    <h2>Comparison Analysis</h2>
    <label>Select companies to compare (multiple)
      <select id="compareSelect" multiple style="height: 100px; width: 100%;"></select>
    </label>
    <button onclick="showComparison()">Run Comparison</button>
    <div id="comparisonResult"></div>
    <canvas id="userChart" width="600" height="300"></canvas>
  </div>

  <script>
    // Saved simulation data
    let savedSimulations = JSON.parse(localStorage.getItem('sijeSimulations')) || [];
    let currentSimulation = null;
    const EXCHANGE_RATE = 1300; // 1 USD = 1300 KRW
    
    // DOM elements
    const simulateBtn = document.getElementById("simulateBtn");
    const saveBtn = document.getElementById("saveBtn");
    const savedSimulationsList = document.getElementById("savedSimulations");
    const compareSelect = document.getElementById("compareSelect");
    
    // Event listeners
    simulateBtn.addEventListener("click", simulateDetails);
    saveBtn.addEventListener("click", saveSimulation);
    
    // Initialize
    updateSavedSimulationsList();
    
    // Format currency (USD)
    function formatCurrency(amount) {
      return amount ? '$' + (amount / EXCHANGE_RATE).toLocaleString('en-US', {maximumFractionDigits: 2}) : '-';
    }
    
    // Main calculation function
    function calculateSubscription(companyType, machines, users) {
      const MONOLOG_UNIT_PRICE = 1200000; // Per 120 machines (KRW)
      const MONOLIS_PRICE = 50000; // Per user (KRW)
      const INSTALLATION_FEE = 15000 * EXCHANGE_RATE; // $15,000 (KRW)
      
      const result = { years: [] };
      
      for (let year = 1; year <= 4; year++) {
        let yearData = {
          year,
          phase: year === 1 ? 'PoC' : (year <= 3 ? 'Expand' : 'Standardize'),
          monolog: 0,
          moai: 0,
          monolis: 0,
          installation: 0,
          total: 0
        };
        
        let applyRatio = 0;
        if (year === 1) {
          yearData.installation = INSTALLATION_FEE; // $15,000 for PoC
        } else if (year === 2 || year === 3) {
          applyRatio = 0.2; // 20% for Expand
        } else if (year === 4) {
          applyRatio = 0.7; // 70% for Standardize
        }
        
        // Production Focused
        if (companyType === "production") {
          if (year >= 2) {
            const appliedMachines = Math.ceil(machines * applyRatio);
            yearData.monolog = Math.ceil(appliedMachines / 120) * MONOLOG_UNIT_PRICE;
            yearData.moai = yearData.monolog * 2;
            
            if (year >= 3) {
              const appliedUsers = Math.ceil(users * applyRatio);
              yearData.monolis = appliedUsers * MONOLIS_PRICE;
            }
          }
        } 
        // Sourcing Focused
        else if (companyType === "sourcing") {
          if (year === 1) {
            // Only installation fee for PoC
          } else if (year >= 2) {
            const appliedMachines = Math.ceil(machines * applyRatio);
            yearData.monolog = Math.ceil(appliedMachines / 120) * MONOLOG_UNIT_PRICE;
            yearData.moai = yearData.monolog * 2;
            
            const appliedUsers = Math.ceil(users * applyRatio);
            yearData.monolis = appliedUsers * MONOLIS_PRICE;
          }
        } 
        // Data Focused
        else if (companyType === "data") {
          if (year === 1) {
            // Only installation fee for PoC
          } else if (year >= 2) {
            const appliedMachines = Math.ceil(machines * applyRatio);
            const monologBase = Math.ceil(appliedMachines / 120) * MONOLOG_UNIT_PRICE;
            yearData.moai = monologBase * 2;
            
            const appliedUsers = Math.ceil(users * applyRatio);
            yearData.monolis = appliedUsers * MONOLIS_PRICE;
          }
        }
        
        yearData.total = yearData.monolog + yearData.moai + yearData.monolis + yearData.installation;
        result.years.push(yearData);
      }
      return result;
    }
    
    // Display results
    function displayResult(result, companyName) {
      let html = `<h2>${companyName} Simulation Results</h2>`;
      html += `<table>
        <tr>
          <th>Year</th>
          <th>Phase</th>
          <th>Monolog</th>
          <th>MoAI</th>
          <th>Monolis</th>
          <th>Installation</th>
          <th class="highlight">Total</th>
        </tr>`;
      
      result.years.forEach(yearData => {
        html += `<tr>
          <td>Year ${yearData.year}</td>
          <td>${yearData.phase}</td>
          <td>${formatCurrency(yearData.monolog)}</td>
          <td>${formatCurrency(yearData.moai)}</td>
          <td>${formatCurrency(yearData.monolis)}</td>
          <td>${formatCurrency(yearData.installation)}</td>
          <td class="highlight">${formatCurrency(yearData.total)}</td>
        </tr>`;
      });
      
      html += `</table>`;
      document.getElementById("result").innerHTML = html;
    }
    
    // Save simulation
    function saveSimulation() {
      if (!currentSimulation) {
        alert("Please run simulation first.");
        return;
      }
      
      const exists = savedSimulations.some(sim => 
        sim.companyName === currentSimulation.companyName && 
        sim.companyType === currentSimulation.companyType
      );
      
      if (exists) {
        alert("Simulation with same company name and type already exists.");
        return;
      }
      
      savedSimulations.push(currentSimulation);
      localStorage.setItem('sijeSimulations', JSON.stringify(savedSimulations));
      updateSavedSimulationsList();
      updateCompareSelect();
      alert("Simulation saved!");
    }
    
    // Update saved simulations list
    function updateSavedSimulationsList() {
      savedSimulationsList.innerHTML = '';
      
      if (savedSimulations.length === 0) {
        savedSimulationsList.innerHTML = '<li>No saved simulations</li>';
        return;
      }
      
      savedSimulations.forEach((sim, index) => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${sim.companyName}</strong> (${getCompanyTypeName(sim.companyType)}) 
          - Machines: ${sim.machines}, Users: ${sim.users} 
          <button onclick="loadSimulation(${index})">View</button>
          <button onclick="deleteSimulation(${index})">Delete</button>`;
        savedSimulationsList.appendChild(li);
      });
    }
    
    // Helper functions
    function getCompanyTypeName(type) {
      switch(type) {
        case 'production': return 'Production';
        case 'sourcing': return 'Sourcing';
        case 'data': return 'Data';
        default: return type;
      }
    }
    
    function loadSimulation(index) {
      if (index >= 0 && index < savedSimulations.length) {
        currentSimulation = savedSimulations[index];
        document.getElementById("companyName").value = currentSimulation.companyName;
        document.getElementById("companyType").value = currentSimulation.companyType;
        document.getElementById("machines").value = currentSimulation.machines;
        document.getElementById("users").value = currentSimulation.users;
        displayResult(currentSimulation.result, currentSimulation.companyName);
      }
    }
    
    function deleteSimulation(index) {
      if (confirm("Delete this simulation?")) {
        savedSimulations.splice(index, 1);
        localStorage.setItem('sijeSimulations', JSON.stringify(savedSimulations));
        updateSavedSimulationsList();
        updateCompareSelect();
      }
    }
    
    function updateCompareSelect() {
      compareSelect.innerHTML = '';
      savedSimulations.forEach((sim, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${sim.companyName} (${getCompanyTypeName(sim.companyType)})`;
        compareSelect.appendChild(option);
      });
    }
    
    function showComparison() {
      const selectedIndices = Array.from(compareSelect.selectedOptions).map(opt => parseInt(opt.value));
      
      if (selectedIndices.length < 2) {
        alert("Select at least 2 simulations to compare.");
        return;
      }
      
      const selectedSimulations = selectedIndices.map(index => savedSimulations[index]);
      displayComparison(selectedSimulations);
    }
    
    function displayComparison(simulations) {
      let html = `<h3>Comparison Results</h3><table><tr><th>Company</th>`;
      
      for (let year = 1; year <= 4; year++) {
        html += `<th>Year ${year} Total</th>`;
      }
      html += `</tr>`;
      
      simulations.forEach(sim => {
        html += `<tr><td>${sim.companyName}</td>`;
        sim.result.years.forEach(yearData => {
          html += `<td>${formatCurrency(yearData.total)}</td>`;
        });
        html += `</tr>`;
      });
      
      html += `</table>`;
      document.getElementById("comparisonResult").innerHTML = html;
      createComparisonChart(simulations);
    }
    
    function createComparisonChart(simulations) {
      const ctx = document.getElementById('userChart').getContext('2d');
      
      if (window.comparisonChart) {
        window.comparisonChart.destroy();
      }
      
      const labels = simulations.map(sim => sim.companyName);
      const datasets = [];
      
      for (let year = 1; year <= 4; year++) {
        datasets.push({
          label: `Year ${year}`,
          data: simulations.map(sim => sim.result.years[year-1].total / EXCHANGE_RATE), // Convert to USD
